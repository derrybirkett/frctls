name: AI Content Generation

on:
  schedule:
    # Generate content every Sunday at 6:00 AM UTC (day before Tuesday publishing)
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      topic_override:
        description: 'Override topic for content generation'
        required: false
        type: string
      target_date:
        description: 'Target publication date (YYYY-MM-DD)'
        required: false
        type: string

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  generate-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required: Commit generated content
      actions: read  # Required: Read workflow state
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install --no-cache
          echo "Dependencies installed:"
          npm list

      - name: Generate content
        id: generate
        run: |
          echo "ğŸš€ Starting AI content generation..."
          cd .github/scripts
          node generate-content.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOPIC_OVERRIDE: ${{ github.event.inputs.topic_override }}
          TARGET_DATE: ${{ github.event.inputs.target_date }}

      - name: Commit generated content
        if: steps.generate.outputs.content_created == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action AI"
          git add apps/blog/src/content/drafts/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: add AI-generated blog post - ${{ steps.generate.outputs.post_title }}"
            git push
            echo "âœ… Content committed and pushed successfully"
          fi

      - name: Summary
        if: steps.generate.outputs.content_created == 'true'
        run: |
          echo "âœ… Content generated successfully!"
          echo "ğŸ“ Post: ${{ steps.generate.outputs.post_title }}"
          echo "ğŸ“… Target Date: ${{ steps.generate.outputs.target_date }}"
          echo "ğŸ“Š Word Count: ${{ steps.generate.outputs.word_count }}"
          echo "ğŸ¯ Topic: ${{ steps.generate.outputs.topic }}"
          echo "ğŸ“‚ File: ${{ steps.generate.outputs.slug }}.md"
          echo ""
          echo "The content has been added to drafts and will be published automatically"
          echo "on the next scheduled publication date (Tuesday or Friday)."