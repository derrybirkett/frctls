name: AI Content Generation

on:
  schedule:
    # Generate content every Sunday at 6:00 AM UTC (day before Tuesday publishing)
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      topic_override:
        description: 'Override topic for content generation'
        required: false
        type: string
      target_date:
        description: 'Target publication date (YYYY-MM-DD)'
        required: false
        type: string

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  generate-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install --no-cache
          echo "Dependencies installed:"
          npm list

      - name: Generate content
        id: generate
        run: |
          echo "ğŸ” Debug information:"
          echo "Working directory: $(pwd)"
          echo "Files in .github/scripts:"
          ls -la .github/scripts/
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Environment variables:"
          echo "- OPENAI_API_KEY: ${OPENAI_API_KEY:0:10}..."
          echo "- TOPIC_OVERRIDE: $TOPIC_OVERRIDE"
          echo "- TARGET_DATE: $TARGET_DATE"
          echo ""
          echo "ğŸš€ Starting content generation..."
          cd .github/scripts
          node generate-content.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOPIC_OVERRIDE: ${{ github.event.inputs.topic_override }}
          TARGET_DATE: ${{ github.event.inputs.target_date }}

      - name: Commit generated content
        if: steps.generate.outputs.content_created == 'true'
        run: |
          echo "ğŸ”§ Configuring git..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action AI"
          
          echo "ğŸ“‚ Checking for generated files..."
          ls -la apps/blog/src/content/drafts/
          
          echo "â• Adding files to git..."
          git add apps/blog/src/content/drafts/
          
          echo "ğŸ” Checking git status..."
          git status
          
          if git diff --staged --quiet; then
            echo "âŒ No changes to commit"
          else
            echo "ğŸ’¾ Committing changes..."
            git commit -m "feat: add AI-generated blog post - ${{ steps.generate.outputs.post_title }}"
            echo "ğŸš€ Pushing to repository..."
            git push
            echo "âœ… Content committed and pushed successfully"
          fi

      - name: Summary
        if: steps.generate.outputs.content_created == 'true'
        run: |
          echo "âœ… Content generated successfully!"
          echo "ğŸ“ Post: ${{ steps.generate.outputs.post_title }}"
          echo "ğŸ“… Target Date: ${{ steps.generate.outputs.target_date }}"
          echo "ğŸ“Š Word Count: ${{ steps.generate.outputs.word_count }}"
          echo "ğŸ¯ Topic: ${{ steps.generate.outputs.topic }}"
          echo "ğŸ“‚ File: ${{ steps.generate.outputs.slug }}.md"
          echo ""
          echo "The content has been added to drafts and will be published automatically"
          echo "on the next scheduled publication date (Tuesday or Friday)."