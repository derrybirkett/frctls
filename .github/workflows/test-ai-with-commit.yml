name: Test AI with Commit

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Topic for content generation'
        required: false
        default: 'Test Topic for AI Generation'

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install
      
      - name: Generate content
        id: generate
        run: |
          cd .github/scripts
          node generate-content.js
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TOPIC_OVERRIDE: ${{ github.event.inputs.topic }}
      
      - name: Check if file was created
        run: |
          echo "Checking for generated files..."
          ls -la apps/blog/src/content/drafts/
          if [ -f apps/blog/src/content/drafts/*.md ]; then
            echo "✅ Files found in drafts directory"
          else
            echo "❌ No files found in drafts directory"
          fi
      
      - name: Commit generated content
        if: steps.generate.outputs.content_created == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add apps/blog/src/content/drafts/
          git commit -m "feat: add AI-generated blog post - ${{ steps.generate.outputs.post_title }}" || echo "No changes to commit"
          git push || echo "Nothing to push"
      
      - name: Show results
        run: |
          echo "Content created: ${{ steps.generate.outputs.content_created }}"
          echo "Post title: ${{ steps.generate.outputs.post_title }}"
          echo "Topic: ${{ steps.generate.outputs.topic }}"