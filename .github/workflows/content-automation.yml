name: Content Automation

on:
  schedule:
    # Run every Tuesday and Friday at 9 AM UTC (for regular posting schedule)
    - cron: '0 9 * * 2,5'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check-drafts'
        type: choice
        options:
          - check-drafts
          - publish-scheduled
          - generate-content-ideas

permissions:
  contents: write  # Required: Move files and commit changes
  pull-requests: write  # Required: Create PRs for scheduled content

jobs:
  content-automation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.1

      - name: Install dependencies
        run: |
          cd apps/blog
          pnpm install

      - name: Check for scheduled content
        id: check-content
        run: |
          echo "Checking for content scheduled for publication..."

          # Get current date in YYYY-MM-DD format
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          CURRENT_TIMESTAMP=$(date -u +"%s")
          echo "Current date: $CURRENT_DATE"

          # Look for draft posts that should be published (pubDate <= today)
          if [ -d "apps/blog/src/content/drafts" ]; then
            READY_POSTS=""

            # Find all markdown files (excluding .gitkeep)
            for post in apps/blog/src/content/drafts/*.md; do
              # Skip if no .md files exist
              [ -e "$post" ] || continue

              # Extract pubDate from frontmatter
              PUB_DATE=$(grep -m 1 "^pubDate:" "$post" | sed -E "s/^pubDate:[[:space:]]*['\"]?([0-9]{4}-[0-9]{2}-[0-9]{2})['\"]?.*/\1/")

              if [ -n "$PUB_DATE" ]; then
                echo "Checking $post with pubDate: $PUB_DATE"

                # Convert dates to timestamps for comparison
                PUB_TIMESTAMP=$(date -u -d "$PUB_DATE" +"%s" 2>/dev/null || echo "0")

                # If pubDate <= current date, add to list
                if [ "$PUB_TIMESTAMP" -le "$CURRENT_TIMESTAMP" ] && [ "$PUB_TIMESTAMP" -gt "0" ]; then
                  echo "  â†’ Ready for publication!"
                  READY_POSTS="$READY_POSTS $post"
                else
                  echo "  â†’ Not yet ready (scheduled for future)"
                fi
              else
                echo "Warning: Could not extract pubDate from $post"
              fi
            done

            # Set output based on whether we found posts
            if [ -n "$READY_POSTS" ]; then
              echo "ready_posts=true" >> $GITHUB_OUTPUT
              # Store as newline-separated list
              echo "posts_to_publish<<EOF" >> $GITHUB_OUTPUT
              echo "$READY_POSTS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "Found $(echo $READY_POSTS | wc -w) post(s) ready for publication"
            else
              echo "ready_posts=false" >> $GITHUB_OUTPUT
              echo "No posts ready for publication"
            fi
          else
            echo "ready_posts=false" >> $GITHUB_OUTPUT
            echo "Drafts directory not found"
          fi

      - name: Move scheduled posts to published
        if: steps.check-content.outputs.ready_posts == 'true'
        run: |
          echo "Moving scheduled posts to published directory..."

          # Create published directory if it doesn't exist
          mkdir -p apps/blog/src/content/blog

          # Move ready posts from drafts to blog
          POSTS_PUBLISHED=0
          for post in ${{ steps.check-content.outputs.posts_to_publish }}; do
            if [ -f "$post" ]; then
              filename=$(basename "$post")
              mv "$post" "apps/blog/src/content/blog/$filename"
              echo "âœ… Published: $filename"
              POSTS_PUBLISHED=$((POSTS_PUBLISHED + 1))
            else
              echo "âš ï¸  Warning: File not found: $post"
            fi
          done

          echo "ðŸ“Š Total posts published: $POSTS_PUBLISHED"

      - name: Create Pull Request for published content
        if: steps.check-content.outputs.ready_posts == 'true'
        uses: peter-evans/create-pull-request@v5
        id: create-pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: publish scheduled blog content"
          title: "ðŸš€ Publish Scheduled Blog Content"
          body: |
            ## Automated Content Publication
            
            This PR publishes blog content that was scheduled for today's date.
            
            ### Changes
            - Moved scheduled posts from drafts to published
            - Content will be automatically deployed after merge
            
            *This PR was created automatically by the content automation workflow and will be auto-merged once checks pass.*
          branch: automated/publish-content-${{ github.run_number }}
          delete-branch: true
          auto-merge: true
          auto-merge-method: squash
          labels: automated,content-publish

      - name: Generate content ideas (manual trigger)
        if: github.event.inputs.action == 'generate-content-ideas'
        run: |
          echo "Generating content ideas based on our content pillars..."
          
          # Create content ideas file
          cat > content-ideas-$(date +%Y-%m-%d).md << 'EOF'
          # Content Ideas - $(date +%Y-%m-%d)
          
          ## Theory Pillar
          - "The Network Effect of Cultural Tokens"
          - "Measuring Fractal Change: KPIs That Actually Matter"
          - "Why Traditional Change Management Creates Resistance"
          
          ## Leadership Pillar  
          - "A Director's Guide to Identifying Cultural Bottlenecks"
          - "Building Change Champions Without Formal Authority"
          - "The Art of Invisible Leadership in Transformation"
          
          ## Case Studies Pillar
          - "How [Company] Transformed 10,000 Employees with 3 Small Changes"
          - "The Meeting Token That Saved $2M Annually"
          - "From Bureaucracy to Agility: A Fortune 500 Transformation"
          
          ## Implementation Pillar
          - "Your First 30 Days: A Fractal Change Playbook"
          - "Tools for Tracking Cultural Token Adoption"
          - "Creating Feedback Loops That Drive Sustainable Change"
          
          ## Seasonal/Trending Topics
          - "New Year, New Culture: Planning Transformation for $(date +%Y)"
          - "Q$((($(date +%-m)-1)/3+1)) Planning: Fractal Changes for This Quarter"
          EOF
          
          echo "Content ideas generated and saved to content-ideas-$(date +%Y-%m-%d).md"