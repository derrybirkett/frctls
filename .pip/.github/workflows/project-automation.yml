name: Project Board Automation

on:
  issues:
    types: [opened, assigned, closed]
  pull_request:
    types: [opened, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    
    steps:
      - name: Add roadmap issue to project
        if: |
          github.event_name == 'issues' &&
          github.event.action == 'opened' &&
          contains(github.event.issue.labels.*.name, 'roadmap')
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/derrybirkett/projects/4
          github-token: ${{ secrets.GH_PROJECT_TOKEN }}
      
      - name: Move to In Progress
        if: |
          github.event_name == 'issues' &&
          github.event.action == 'assigned'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PROJECT_TOKEN }}
          script: |
            // Update project item status to "In Progress"
            // This requires GraphQL API call with project item ID
            const query = `
              mutation {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: "PVT_kwHOABVDfM4Ao5Gw"
                    itemId: "${context.payload.issue.node_id}"
                    fieldId: "PVTSSF_lAHOABVDfM4Ao5GwzgNJ3wI"
                    value: { 
                      singleSelectOptionId: "47fc9ee4"
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            try {
              await github.graphql(query);
              console.log('✅ Moved issue to In Progress');
            } catch (error) {
              console.log('⚠️ Could not update project board:', error.message);
            }
      
      - name: Move to Done
        if: |
          github.event_name == 'issues' &&
          github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PROJECT_TOKEN }}
          script: |
            // Update project item status to "Done"
            const query = `
              mutation {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: "PVT_kwHOABVDfM4Ao5Gw"
                    itemId: "${context.payload.issue.node_id}"
                    fieldId: "PVTSSF_lAHOABVDfM4Ao5GwzgNJ3wI"
                    value: { 
                      singleSelectOptionId: "98236657"
                    }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            try {
              await github.graphql(query);
              console.log('✅ Moved issue to Done');
            } catch (error) {
              console.log('⚠️ Could not update project board:', error.message);
            }
